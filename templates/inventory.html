{% extends "base.html" %}

{% block title %}Inventory Management{% endblock %}

{% block content %}
<div class="card">
    <h3>Add New Product</h3>
    <form id="addProductForm" onsubmit="handleFormSubmit(event, 'POST', '/api/products')"
        style="display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end;">
        <div class="form-group">
            <label>Name</label>
            <input type="text" name="name" class="form-control" required placeholder="Product Name">
        </div>
        <div class="form-group">
            <label>Barcode</label>
            <input type="text" name="barcode" class="form-control" required placeholder="Scan Barcode">
        </div>
        <div class="form-group">
            <label>Cost Price</label>
            <input type="number" step="0.01" name="cost_price" class="form-control" required placeholder="Buy Price"
                oninput="calculateMargin(this.form)">
        </div>
        <div class="form-group">
            <label>Price (Sell)</label>
            <input type="number" step="0.01" name="price" class="form-control" required placeholder="Sell Price"
                oninput="calculateMargin(this.form)">
            <small style="display: block; margin-top: 4px; color: #64748b;">
                Margin: <span class="margin-display">-</span>
            </small>
        </div>
        <div class="form-group">
            <label>Stock</label>
            <input type="number" name="stock_quantity" class="form-control" required placeholder="0">
        </div>
        <div class="form-group">
            <label>Category</label>
            <input type="text" name="category" class="form-control" placeholder="General">
        </div>
        <div class="form-group">
            <button type="submit" class="btn btn-primary" style="margin-bottom: 2px;">Add Product</button>
        </div>
    </form>
</div>

<!-- Stock Alert Notification if Any -->
{% if low_stock_alert %}
<div
    style="background: #fef2f2; border: 1px solid #ef4444; color: #991b1b; padding: 15px; border-radius: 8px; margin: 20px 0;">
    <strong>⚠️ Critical Stock Level:</strong> The following items are running low: {{ low_stock_alert|join(', ') }}
</div>
{% endif %}

<div class="card" style="margin-top: 20px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);">
    <div style="display: flex; justify-content: space-around; text-align: center;">
        <div>
            <h4 style="margin:0; color: #64748b;">Total Stock Value (Cost)</h4>
            <div style="font-size: 1.5rem; font-weight: bold; color: #334155;">
                ${{ "%.2f"|format(products|sum(attribute='cost_price_total') if products else 0) }}
            </div>
        </div>
        <div>
            <h4 style="margin:0; color: #64748b;">Potential Revenue</h4>
            <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;">
                ${{ "%.2f"|format(products|sum(attribute='sell_price_total') if products else 0) }}
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 20px;">
    <h3>Product List</h3>
    <div style="overflow-x: auto; max-height: 600px;">
        <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
            <thead style="position: sticky; top: 0; background: #f8fafc; z-index: 10;">
                <tr>
                    <th style="padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: left; color: #64748b;">Name
                        / Barcode</th>
                    <th style="padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: right; color: #64748b;">
                        Buying Price</th>
                    <th style="padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: right; color: #64748b;">
                        Selling Price</th>
                    <th style="padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: right; color: #64748b;">
                        Profit / Margin</th>
                    <th style="padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: center; color: #64748b;">
                        Stock</th>
                    <th style="padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: left; color: #64748b;">
                        Category</th>
                    <th style="padding: 12px; border-bottom: 2px solid #e2e8f0; text-align: right; color: #64748b;">
                        Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for product in products %}
                <tr style="border-bottom: 1px solid #f1f5f9; transition: background 0.2s;"
                    onmouseover="this.style.background='#f8fafc'" onmouseout="this.style.background='transparent'">
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <div style="font-weight: 500; color: #1e293b;">{{ product.name }}</div>
                        <div style="font-size: 0.85rem; color: #94a3b8;">{{ product.barcode }}</div>
                    </td>
                    <td
                        style="padding: 12px; border-bottom: 1px solid #eee; text-align: right; font-family: monospace; font-size: 1rem;">
                        ${{ "%.2f"|format(product.cost_price) }}
                    </td>
                    <td
                        style="padding: 12px; border-bottom: 1px solid #eee; text-align: right; font-family: monospace; font-size: 1rem; font-weight: bold;">
                        ${{ "%.2f"|format(product.price) }}
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">
                        <div
                            style="color: {{ 'var(--success-color)' if product.profit > 0 else 'var(--danger-color)' }}; font-weight: bold;">
                            ${{ "%.2f"|format(product.profit) }}
                        </div>
                        <div style="font-size: 0.8rem; color: #64748b;">
                            {{ "%.1f"|format(product.margin) }}%
                        </div>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: center;">
                        <span style="padding: 4px 10px; border-radius: 99px; font-weight: bold; font-size: 0.85rem; 
                            background: {{ '#fee2e2' if product.stock_quantity < 5 else '#dcfce7' }}; 
                            color: {{ '#991b1b' if product.stock_quantity < 5 else '#166534' }};">
                            {{ product.stock_quantity }}
                        </span>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee;">
                        <span
                            style="background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; font-size: 0.85rem;">{{
                            product.category }}</span>
                    </td>
                    <td style="padding: 12px; border-bottom: 1px solid #eee; text-align: right;">
                        <button class="btn btn-sm btn-primary" onclick='openEditModal({{ product.to_dict()|tojson }})'
                            style="margin-right: 5px;">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteProduct({{ product.id }})">Del</button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 30px; color: #94a3b8;">
                        No products found. Start adding inventory above!
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div class="card" style="width: 400px; max-width: 90%;">
        <h3 style="margin-bottom: 20px;">Edit Product</h3>
        <form id="editProductForm" onsubmit="handleEditSubmit(event)">
            <input type="hidden" name="id" id="edit_id">
            <div class="form-group">
                <label>Name</label>
                <input type="text" name="name" id="edit_name" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Barcode</label>
                <input type="text" name="barcode" id="edit_barcode" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Cost Price (Buy)</label>
                <input type="number" step="0.01" name="cost_price" id="edit_cost_price" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Price (Sell)</label>
                <input type="number" name="price" step="0.01" id="edit_price" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Stock</label>
                <input type="number" name="stock_quantity" id="edit_stock" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Category</label>
                <input type="text" name="category" id="edit_category" class="form-control">
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button type="button" class="btn" onclick="closeModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
    function calculateMargin(form) {
        const cost = parseFloat(form.cost_price.value) || 0;
        const sell = parseFloat(form.price.value) || 0;
        const display = form.querySelector('.margin-display');

        if (cost > 0 && sell > 0) {
            const profit = sell - cost;
            const margin = (profit / cost) * 100;
            const color = profit >= 0 ? 'green' : 'red';
            display.innerHTML = `<span style="color:${color}">${margin.toFixed(1)}% ($${profit.toFixed(2)})</span>`;
        } else {
            display.innerHTML = '-';
        }
    }

    async function handleFormSubmit(event, method, url) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const err = await response.json();
                alert('Error: ' + err.error);
            }
        } catch (e) {
            alert('Failed to connect to server');
        }
    }

    async function deleteProduct(id) {
        if (!confirm('Are you sure you want to delete this product?')) return;

        try {
            const response = await fetch(`/api/product/${id}`, { method: 'DELETE' });
            if (response.ok) {
                window.location.reload();
            } else {
                const err = await response.json();
                alert('Error: ' + err.error);
            }
        } catch (e) {
            alert('Network error');
        }
    }

    function openEditModal(product) {
        document.getElementById('edit_id').value = product.id;
        document.getElementById('edit_name').value = product.name;
        document.getElementById('edit_barcode').value = product.barcode;
        document.getElementById('edit_price').value = product.price;
        document.getElementById('edit_cost_price').value = product.cost_price || 0;
        document.getElementById('edit_stock').value = product.stock_quantity;
        document.getElementById('edit_category').value = product.category || '';

        document.getElementById('editModal').style.display = 'flex';
    }

    function closeModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    async function handleEditSubmit(event) {
        event.preventDefault();
        const id = document.getElementById('edit_id').value;
        const url = `/api/product/${id}`;

        //Reuse generic handler logic manually since we need specific URL
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                window.location.reload();
            } else {
                const err = await response.json();
                alert('Error: ' + err.error);
            }
        } catch (e) {
            alert('Failed to save changes');
        }
    }

    // Close modal if clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('editModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>
{% endblock %}