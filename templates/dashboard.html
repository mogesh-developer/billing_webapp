{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard-stats">

    <!-- Daily Stats -->
    <h4 style="margin-left: 5px; color: #64748b; margin-bottom: 10px;">Daily Overview</h4>
    <div class="stats-grid"
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="card stat-card">
            <div class="stat-title">Sales (Today)</div>
            <div class="stat-value"><span class="currencySym">$</span>{{ "%.2f"|format(today_sales) }}</div>
        </div>
        <div class="card stat-card">
            <div class="stat-title">Profit (Today)</div>
            <div class="stat-value" style="color: var(--success-color);">
                <span class="currencySym">$</span>{{ "%.2f"|format(today_profit) }}
            </div>
        </div>
        <div class="card stat-card">
            <div class="stat-title">Expenses (Today)</div>
            <div class="stat-value" style="color: var(--danger-color);">
                <span class="currencySym">$</span>{{ "%.2f"|format(today_expenses) }}
            </div>
        </div>
    </div>

    <!-- Monthly Stats -->
    <h4 style="margin-left: 5px; color: #64748b; margin-bottom: 10px;">Monthly Overview</h4>
    <div class="stats-grid"
        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
        <div class="card stat-card" style="background: linear-gradient(135deg, #fff 0%, #f0f9ff 100%);">
            <div class="stat-title">Sales (This Month)</div>
            <div class="stat-value" style="color: #0369a1;"><span class="currencySym">$</span>{{
                "%.2f"|format(month_sales) }}</div>
        </div>
        <div class="card stat-card" style="background: linear-gradient(135deg, #fff 0%, #f0fdf4 100%);">
            <div class="stat-title">Profit (This Month)</div>
            <div class="stat-value" style="color: #15803d;"><span class="currencySym">$</span>{{
                "%.2f"|format(month_profit) }}</div>
        </div>
        <div class="card stat-card {{ 'alert' if low_stock > 0 else '' }}">
            <div class="stat-title">Smart Suggestions</div>
            <div class="stat-value" style="font-size: 1.2rem;">
                {{ low_stock }} Items to Restock
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="card" style="margin-bottom: 30px;">
        <h3>Financial Overview (Last 7 Days)</h3>
        <div style="height: 350px;">
            <canvas id="financialChart"></canvas>
        </div>
    </div>

    <div class="dashboard-split" style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px;">
        <!-- Recent Bills -->
        <div class="card">
            <h3>Recent Transactions</h3>
            <table>
                <thead>
                    <tr>
                        <th>Bill #</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bill in recent_bills %}
                    <tr>
                        <td>{{ bill.bill_number }}</td>
                        <td>{{ bill.customer_name }}</td>
                        <td>${{ "%.2f"|format(bill.total_amount) }}</td>
                        <td>{{ bill.date.strftime('%H:%M') }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="4">No sales yet today.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions" style="display: flex; flex-direction: column; gap: 15px;">
            <a href="{{ url_for('billing') }}" class="card action-card primary">
                <h3>üõí New Bill</h3>
                <p>Start POS System</p>
            </a>
            <a href="{{ url_for('expenses') }}" class="card action-card"
                style="background: linear-gradient(135deg, #ef4444, #f87171); color: white;">
                <h3>üí∏ Add Expense</h3>
                <p>Track Spending</p>
            </a>
            <a href="{{ url_for('inventory') }}" class="card action-card">
                <h3>üì¶ Inventory</h3>
                <p>Manage Stock</p>
            </a>
            <a href="{{ url_for('settings') }}" class="card action-card">
                <h3>‚öôÔ∏è Settings</h3>
                <p>Shop Config</p>
            </a>
        </div>
    </div>

</div>

<!-- Auto-fetch currency symbol for dashboard -->
<script>
    fetch('/api/settings')
        .then(r => r.json())
        .then(d => {
            if (d.currency_symbol) {
                document.querySelectorAll('.currencySym').forEach(e => e.innerText = d.currency_symbol);
            }
        });

    // Chart.js Setup
    const ctx = document.getElementById('financialChart').getContext('2d');

    // Safely parse data from backend
    const labels = {{ chart_labels | tojson }};
    const salesData = {{ chart_data | tojson }};
    const profitData = {{ chart_profit | tojson }};
    const expenseData = {{ chart_expenses | tojson }};

    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Sales',
                    data: salesData,
                    backgroundColor: 'rgba(99, 102, 241, 0.7)',
                    borderColor: '#6366f1',
                    borderWidth: 1,
                    order: 2
                },
                {
                    label: 'Expenses',
                    data: expenseData,
                    backgroundColor: 'rgba(239, 68, 68, 0.7)',
                    borderColor: '#ef4444',
                    borderWidth: 1,
                    order: 3
                },
                {
                    type: 'line',
                    label: 'Net Profit',
                    data: profitData,
                    borderColor: '#10b981',
                    borderWidth: 3,
                    tension: 0.4,
                    fill: false,
                    order: 1,
                    pointBackgroundColor: '#10b981',
                    pointRadius: 5
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            },
            interaction: {
                mode: 'nearest',
                axis: 'x',
                intersect: false
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { color: 'rgba(0,0,0,0.05)' }
                },
                x: {
                    grid: { display: false }
                }
            }
        }
    });

    // Dark Mode Chart Update Listener
    const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
            if (mutation.attributeName === "class") {
                const isDark = document.body.classList.contains('dark-mode');
            }
        });
    });
    observer.observe(document.body, { attributes: true });
</script>
{% endblock %}